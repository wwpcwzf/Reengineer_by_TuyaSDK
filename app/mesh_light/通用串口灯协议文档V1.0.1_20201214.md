# 通用串口灯协议文档

|版本|作者|备注|时间|
|:--:|--|--|:--:|
|1.0.0|蒋俊杰|初版|2020-05-20|
|1.0.1|何康馨|增加数据用例|2020-12-01|

## 一、波特率及命名格式说明
Baud rate:9600     Data bits:8      Stop bits:1

|字段|长度(byte)|说明|
|:--:|--|:--:|
|帧头|2|0xa55a|
|版本|1|0x00|
|命令字|1|cmd|
|功能项|1|featue|
|数据长度|2|len|
|数据|数据长度|prarams[len]|
|校验和|1|从帧头开始按字节求和得出的结果对256求余|
## 二、命令字解析
|命令字|命令值|说明|
|:--:|--|:--:|
|write|0x01|BT发送数据给MCU需回复，已确保收到|
|wrtie-noack|0x02|BT发送数据给MCU，MCU无需回复|
|read|0x03|BT向MCU读取数据(非标准DP)|
|status|0x04|MCU向BT返回相应数据(read和write的回复)|
|Data|0x05|MCU通过BT上报数据(主动上报)|
|Rev-control_noack|0x07|MCU控制BT,例如开关等,无需BT回复|
|Rev-read|0x08|MCU向BT读取数据|
|Rev-status|0x09|BT响应MCU的读取命令|
## 三、功能项解析
### 功能预览表
|功能项|功能ID|
|:--:|:--:|
|交互开始,MCU通知BT在线|0x00|
|重置BT|0x01|
|mesh状态|0x02|
|灯功能:开关,模式,亮度,冷暖,彩光,音乐律动|0x10|
|场景ID|0x11|
|完整场景|0x12|
|倒计时|0x13|
|透传DP|0x20|

### 1、交互开始--0x00:
|字段|长度|说明|
|:--:|--|:--:|
|交互|1|00:交互截至<br>01:交互截至|
|控制信息|1|00:灯不发送给MCU<br>01:灯将标准dp定义的控制信息发送给MCU|

  注意：MCU上线后需向BT发送交互信息，交互开始时，BT才使能交互功能。

  通知BT交互开始，并接收灯控制相关信息，无回复
  MCU：A5 5A 00 07 00 00 02 01 01 0A  

  通知BT交互开始，并接收灯控制相关信息，有回复
  MCU：A5 5A 00 06 00 00 02 01 01 09
  BT：A5 5A 00 09 00 00 02 01 01 0C

### 2、重置BT---0x01:
|字段|长度|说明|
|:--:|--|:--:|
|重置|1|01:重置BT|

注意：重置BT后，交互截至（命令字为0x07或0x06都无BT反馈），需重新发送交互信息

重置BT ：无回复
MCU：A5 5A 00 07 01 00 01 01 09 

### 3、mesh状态---0x02:
|字段|长度|说明|
|:--:|--|:--:|
|mesh状态|1|00:未配网<br>01:已配网|

查询mesh状态 ：
MCU：A5 5A 00 08 02 00 00 09 
回复mesh状态已配网
BT：A5 5A 00 09 02 00 01 01 0C 

### 4、灯功能---0x10:

|字段|长度|说明|
|:--:|--|:--:|
|有效位|1|8bits 最低位1bits为1表示开关有效，为0表示开关的值无效；依次类推|
|模式|1|00:白光<br>01:彩光<br>02:场景<br>03:音乐|
|色相H|2|HEX格式, 范围0x0000~0x0168（即0~360）|
|饱和度S|2|HEX格式, 范围0x0000~0x03E8（即0~1000）|
|明度V|2|HEX格式, 范围0x000A~0x03E8（即10~1000）|
|亮度B|2|HEX格式, 范围0x000A~0x03E8（即10~1000）|
|色温T|2|HEX格式, 范围0x0000~0x03E8（即0~1000）|

MCU控制BT：开关、亮度、色温位有效，开灯，亮度0xFF，色温0x55，无回复
MCU：A5 5A 00 07 10 00 0D 61 01 00 00 00 00 00 00 00 00 FF 00 55 D9
MCU控制BT：开关位有效，关灯，无回复
MCU：A5 5A 00 07 10 00 0D 01 00 00 00 00 00 00 00 00 00 00 00 00 24

MCU读取BT灯功能状态： 
MCU：A5 5A 00 08 10 00 00 01 63 7B
BT回复：
BT：A5 5A 00 09 10 00 0D 63 01 02 00 00 00 00 00 00 01 E9 01 F8 6E

### 5、场景ID---0x11:
|字段|长度|说明|
|:--:|--|:--:|
|场景ID号|1|表明当前执行的场景ID号|

场景号控制：4号场景，有回复
MCU：A5 5A 00 06 11 00 01 04 1B 
BT回复：
BT：A5 5A 00 09 11 00 01 04 1E 

当前场景号查询： 
MCU：A5 5A 00 08 11 00 00 18 
BT回复：
BT：A5 5A 00 09 11 00 01 04 1E 

### 6、完整场景---0x12:
|字段|长度|说明|
|:--:|--|:--:|
|场景ID号|1|表明场景ID号|
|场景内容|N|查看附录<场景协议>|

注意：1.可依据电量或红外遥控器,修改场景内容的亮度
      2. MCU发送的场景数据到BT后，会被BT压缩处理，下例“单元变化时间―0a”会被压缩，读回的值与“单元切换间隔时间―0b”相等
      3. BT压缩处理时，彩光(H S V)和白光(色温 亮度值)互斥，彩光和白光在同一个场景单元里同时控制，会优先压缩白光数据，丢失彩光数据

场景内容：（string型）“010b0a0100000000000003e803e80b0a01007803e803e800000000”
完整场景控制：4号场景，有回复
MCU：A5 5A 00 06 12 00 37 01 30 31 30 62 30 61 30 31 30 30 30 30 30 30 30 30 30 30 30 30 30 33 65 38 30 33 65 38 30 62 30 61 30 31 30 30 37 38 30 33 65 38 30 33 65 38 30 30 30 30 30 30 30 30 47 
BT回复：
BT：A5 5A 00 09 12 00 37 01 30 31 30 62 30 61 30 31 30 30 30 30 30 30 30 30 30 30 30 30 30 33 65 38 30 33 65 38 30 62 30 61 30 31 30 30 37 38 30 33 65 38 30 33 65 38 30 30 30 30 30 30 30 30 4A 

当前完整场景查询： 
MCU：A5 5A 00 08 12 00 00 19 
BT回复（hex型）：
BT：A5 5A 00 09 12 00 1B 01 0B 0B 01 00 00 00 00 00 00 03 E8 03 E8 0B 0B 01 00 78 03 E8 03 E8 00 00 00 00 88 

### 7、倒计时---0x13:

|字段|长度|说明|
|:--:|--|:--:|
|倒计时时长|4|hex型,由高到低|

注意：倒计时时间结束后，灯状态取反，如现灯为开，倒计时结束后关，若为关状态，则开

倒计时控制：1分钟，有回复
MCU：A5 5A 00 06 13 00 04 00 00 00 3C 58 
BT回复：
BT：A5 5A 00 09 13 00 04 00 00 00 3C 5B

当前倒计时查询： 
MCU：A5 5A 00 08 13 00 00 1A 
BT回复：
BT：A5 5A 00 09 13 00 04 00 00 00 39 58 

### 8、透传DP---0x20:

|字段|长度|说明|
|:--:|--|:--:|
|DP内容|N|查看附录<DP封装表>|

# 附录：

## 1、DP封装表:
在串口通信协议中<非标准DP命令上传、下发 >有dp点的数据封装，其封装规则按照下表：
|字段|长度(byte)|说明|
|:--:|--|:--:|
|dpid|1|datapoint序号|
|type|1|对应开放平台上某datapoint具体的数据类型，通过如下“表示值”表示|


## 2、场景协议：BT给出是hex型

Dp25: 情景
类型：字符   Value:0011223344445555666677778888

00：情景号

11：单元切换间隔时间（0-100）

22：单元变化时间（0-100）

33：单元变化模式（0 静态 1跳变 2 渐变）

4444：H（色度：0-360，0X0000-0X0168）

5555：S（饱和：0-1000，0X0000-0X03E8）

6666：V（明度：0-1000，0X0000-0X03E8）

7777:白光亮度（0-1000）

8888：色温值（0-1000）

注：数字1-8的标号对应有多少单元就有多少组

实例：

{“25”：“010b0a02000003e803e8000000000b0a02007603e803e8000000000b0a0200e703e803e800000000”}





